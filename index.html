<!doctype html> 
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NeuralNet Coin (NNC)</title>
  <link rel="icon" type="image/png" href="nnc_logo.png" />
  <style>
    :root{--bg:radial-gradient(circle at top,#111827 0%,#000 50%,#000 100%);--card:rgba(15,23,42,.55);--border:rgba(148,163,184,.15);--accent:#38bdf8}
    *{box-sizing:border-box}body{margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:var(--bg);color:#fff;min-height:100vh}
    header{border-bottom:1px solid rgba(255,255,255,.03);backdrop-filter:blur(12px);position:sticky;top:0;z-index:20;background:rgba(0,0,0,.35)}
    .nav-inner{max-width:1200px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;padding:1rem 1.25rem}
    .logo-wrap{display:flex;gap:.6rem;align-items:center}.coin-dot{width:80px;height:auto;object-fit:contain;background:transparent;border:none}
    .nav-links a{margin-left:1rem;color:rgba(255,255,255,.65);text-decoration:none;font-size:.85rem}.nav-links a:hover{color:#fff}
    .hero{max-width:1200px;margin:0 auto;padding:2.2rem 1.25rem 1.8rem;display:grid;grid-template-columns:1.1fr .9fr;gap:2rem}
    @media (max-width:900px){.hero{grid-template-columns:1fr}}
    .badge{font-size:.6rem;letter-spacing:.35em;text-transform:uppercase;background:rgba(56,189,248,.08);color:#e2f3ff;padding:.35rem .85rem;border:1px solid rgba(56,189,248,.3);border-radius:9999px;display:inline-block;margin-bottom:1.2rem}
    h1{font-size:clamp(2.4rem,5vw,3.3rem);line-height:1;margin-bottom:1rem}
    .muted{color:rgba(226,232,255,.68);line-height:1.6;max-width:34rem;font-size:.95rem;margin-bottom:1.2rem}
    .btn-row{display:flex;gap:.65rem;flex-wrap:wrap}.btn-primary{background:#fff;color:#000;padding:.6rem 1.35rem;border-radius:.75rem;border:none;font-weight:600;cursor:pointer;font-size:.85rem}
    .btn-secondary{background:rgba(255,255,255,.04);border:1px solid rgba(226,232,255,.12);color:#fff;padding:.6rem 1.35rem;border-radius:.75rem;font-weight:500;cursor:pointer}
    .panel{background:var(--card);border:1px solid var(--border);border-radius:1.25rem;padding:1.25rem 1.2rem 1.2rem;box-shadow:0 10px 40px rgba(15,23,42,.25)}
    .panel-title{font-weight:600;margin-bottom:1rem;display:flex;justify-content:space-between;align-items:center}
    .kv-row{display:flex;justify-content:space-between;margin-bottom:.65rem;gap:1rem}.kv-label{color:rgba(226,232,255,.45);font-size:.75rem}.kv-value{font-size:.75rem;word-break:break-all}
    .section{max-width:1200px;margin:0 auto;padding:1.5rem 1.25rem 2rem}.section h2{margin-bottom:.65rem}
    .presale-box{background:linear-gradient(135deg,rgba(148,163,184,.04),rgba(56,189,248,.05));border:1px solid rgba(148,163,184,.25);border-radius:1.25rem;padding:1rem 1.25rem;max-width:32rem}
    .small{font-size:.75rem;color:rgba(226,232,255,.55)}footer{text-align:center;padding:1.5rem 1.25rem 2.5rem;color:rgba(148,163,184,.35);font-size:.7rem}
    .status-pill{background:rgba(250,204,21,.12);color:#fde68a;font-size:.65rem;padding:.35rem .6rem;border-radius:9999px}
    .pay-btn{background:#fff;color:#000;border:none;padding:.55rem 1rem;border-radius:.5rem;font-weight:600;cursor:pointer;font-size:.75rem}.pay-btn:disabled{opacity:.35;cursor:not-allowed}
    .status-text{font-size:.7rem;margin-top:.55rem;color:#bae6fd;word-break:break-all}
    .linkish{background:transparent;border:1px solid rgba(226,232,255,.12);color:#fff;padding:.55rem 1rem;border-radius:.5rem;font-weight:500;cursor:pointer;font-size:.75rem}
    .field{display:flex;gap:.5rem;align-items:center;margin:.4rem 0}
    .field label{width:5.1rem; font-size:.8rem; color:rgba(226,232,255,.75)}
    .field input[type="number"], .field input[type="text"]{flex:1;background:rgba(255,255,255,.05);border:1px solid rgba(148,163,184,.25);color:#fff;border-radius:.5rem;padding:.5rem .6rem;font-size:.85rem}
    .help{font-size:.7rem;color:rgba(226,232,255,.6);margin-top:.15rem}
    .help.error{color:#fecaca}
  </style>
</head>
<body>
  <header>
    <div class="nav-inner">
      <div class="logo-wrap">
        <img src="nnc_logo.png" onerror="this.onerror=null;this.src='nnc_logo.jpg';" alt="NeuralNet Coin logo" class="coin-dot" />
        <div>
          <div style="font-weight:600; font-size:.9rem;">NeuralNet Coin</div>
          <div style="font-size:.65rem; color:rgba(255,255,255,0.4);">Solana ‚Ä¢ Token-2022</div>
        </div>
      </div>
      <div class="nav-links">
        <a href="#about">About</a>
        <a href="#presale">Pre-sale</a>
        <a href="#docs">Docs</a>
      </div>
    </div>
  </header>

  <section class="hero">
    <div>
      <span class="badge">AI-DRIVEN ‚Ä¢ MARKETPLACE UTILITY</span>
      <h1>NeuralNet Coin (NNC)</h1>
      <p class="muted">
        A transparent token for a social-AI economy. We‚Äôre rolling out marketplace payments and
        controlled pre-sales before opening liquidity pools to the public.
      </p>
      <div class="btn-row">
        <a href="#presale"><button class="btn-primary">View Pre-Sale</button></a>
        <a href="#docs"><button class="btn-secondary">Read Whitepaper</button></a>
      </div>
    </div>

    <div class="panel">
      <div class="panel-title">
        <span>Token snapshot</span>
        <span class="status-pill">metadata syncing</span>
      </div>
      <div class="kv-row"><span class="kv-label">Network</span><span class="kv-value">Solana (Token-2022)</span></div>
      <div class="kv-row"><span class="kv-label">Mint</span><span class="kv-value">BhwvuTEBCdYYCUVWSCmpekG42TrpNQxNUGHyR5rQtxtF</span></div>
      <div class="kv-row"><span class="kv-label">Treasury</span><span class="kv-value">JD2sVKxN11Ezn4AYVD4s2JiRUt1Y5Rb5SFueCD5FsmVN</span></div>
      <div class="kv-row"><span class="kv-label">Stage</span><span class="kv-value">Website pre-sale (manual fulfill)</span></div>
      <p class="small" style="margin-top:1rem;">Final token image will appear on explorers once Solana Explorer finishes cache refresh.</p>
    </div>
  </section>

  <section class="section" id="about">
    <h2>Why this site first?</h2>
    <p class="muted" style="max-width:46rem;">
      Instead of throwing NNC straight into a liquidity pool where bots and early dumpers can wreck the pricing,
      we‚Äôre doing a controlled, on-site pre-sale.
    </p>
  </section>

  <section class="section" id="presale">
    <h2>Pre-sale (prototype)</h2>
    <p class="muted" style="max-width:40rem;">
      Connect Phantom, send a payment to the NNC developer/treasury wallet, and we‚Äôll later hook this into the distributor.
    </p>
    <p class="muted" style="margin-top:1rem; margin-bottom:1.2rem;">
      <strong>Presale Rules:</strong><br>
      ‚Ä¢ 1 NNC = $0.0001 USD (‚âà 15 800 NNC per 0.01 SOL)<br>
      ‚Ä¢ Minimum contribution: 0.005 SOL<br>
      ‚Ä¢ Maximum per wallet: 0.25 SOL<br>
      ‚Ä¢ Manual distribution ‚Äî tokens are sent after verification.<br>
    </p>

    <div class="presale-box">
      <p style="font-weight:600; margin-bottom:.5rem;">1. Connect wallet</p>
      <div class="btn-row" style="margin:.2rem 0 .2rem;">
        <button id="connectBtn" class="pay-btn">Connect Phantom</button>
        <!-- mobile-only helper (hidden on desktop) -->
        <button id="openPhantomBtn" class="linkish" type="button" style="display:none;" title="Open this page inside Phantom app">Open in Phantom App</button>
      </div>
      <div id="walletAddr" class="status-text"></div>

      <p style="font-weight:600; margin-top:1.3rem; margin-bottom:.5rem;">2. Send Payment</p>
      <div class="field">
        <label for="amountSol">Amount</label>
        <input id="amountSol" type="number" min="0.005" max="0.25" step="0.001" value="0.01" inputmode="decimal" />
      </div>
      <div id="amountHelp" class="help">Min 0.005 ‚Ä¢ Max 0.25 ‚Ä¢ ‚âà $‚Äî</div>

      <div class="field">
        <label for="memoInput">Memo</label>
        <input id="memoInput" type="text" maxlength="120" placeholder="Optional note (e.g., handle/email)" />
      </div>
      <div class="btn-row" style="margin:.4rem 0 .2rem;">
        <button id="payBtn" class="pay-btn" onclick="sendPayment()" disabled>Pay 0.01 SOL to NNC</button>
        <button id="setRpcBtn" class="linkish" type="button" title="Set your Solana RPC endpoint">Set RPC</button>
      </div>
      <div id="txStatus" class="status-text"></div>
      <p class="small" style="margin-top:.8rem;">
        After payment, verify the signature on
        <a href="https://explorer.solana.com/" target="_blank" style="color:var(--accent); text-decoration:none;">Solana Explorer</a>.
      </p>
    </div>
  </section>

  <section class="section" id="docs">
    <h2>Docs & resources</h2>
    <p class="muted">Latest whitepaper and roadmap are hosted on GitHub and Substack.</p>
    <ul style="list-style:none; padding-left:0; margin-top:1rem; display:grid; gap:.5rem;">
      <li>‚Ä¢ GitHub (whitepaper + token-2022 notes): <a href="https://github.com/HallbjornDeFi/NeuralNetCoin" style="color:var(--accent);" target="_blank" rel="noreferrer">github.com/HallbjornDeFi/NeuralNetCoin</a></li>
      <li>‚Ä¢ Marketplace beta concept ‚Äî NNC-only services</li>
      <li>‚Ä¢ Token metadata updates log</li>
    </ul>
  </section>

  <footer>NeuralNet Coin ‚Äî transparent, utility-first, AI-aligned.</footer>

  <!-- Globals required by web3/browser builds -->
  <script>
    if (!window.global) window.global = window;
    if (!window.process) window.process = { env: {} };
  </script>

  <!-- Buffer polyfill BEFORE web3 -->
  <script src="https://cdn.jsdelivr.net/npm/buffer@6.0.3/index.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>
    (function () {
      const B = window?.buffer?.Buffer;
      if (!B) throw new Error('Buffer polyfill failed to load');
      window.Buffer = B; globalThis.Buffer = B;
      window.buffer ||= { Buffer: B }; globalThis.buffer ||= { Buffer: B };
    })();
  </script>

  <!-- Your configured RPC (keep your Helius URL or override) -->
  <script>
    window.__NNC_RPC__ = window.__NNC_RPC__ || "https://mainnet.helius-rpc.com/?api-key=e259f5af-7b93-4753-b6d2-3f75b5571108";
  </script>

  <!-- web3 AFTER polyfills -->
  <script src="https://unpkg.com/@solana/web3.js@1.95.0/lib/index.iife.js"></script>

  <script>
    const connectBtn = document.getElementById("connectBtn");
    const openPhantomBtn = document.getElementById("openPhantomBtn");
    const payBtn = document.getElementById("payBtn");
    const setRpcBtn = document.getElementById("setRpcBtn");
    const walletAddr = document.getElementById("walletAddr");
    const txStatus = document.getElementById("txStatus");
    const amountInput = document.getElementById("amountSol");
    const amountHelp = document.getElementById("amountHelp");
    const memoInput = document.getElementById("memoInput");

    const TREASURY = "JD2sVKxN11Ezn4AYVD4s2JiRUt1Y5Rb5SFueCD5FsmVN";
    const CLUSTER = "mainnet-beta";
    const MIN_SOL = 0.005, MAX_SOL = 0.25;

    function getProvider() {
      if (window.solana?.isPhantom) return window.solana;
      if (window.phantom?.solana) return window.phantom.solana;
      return null;
    }

    /* Mobile helpers (show CTA only; main deep-link fix is appended at end) */
    function isMobileWeb() {
      const ua = navigator.userAgent || '';
      const mobile = /Android|iPhone|iPad|iPod/i.test(ua);
      const injected = !!(window.solana?.isPhantom || window.phantom?.solana);
      return mobile && !injected;
    }
    function phantomBrowseLink() {
      return `https://phantom.app/ul/browse/${encodeURIComponent(location.href)}`;
    }
    function updateMobilePhantomCta() {
      const show = isMobileWeb();
      if (openPhantomBtn) openPhantomBtn.style.display = show ? 'inline-block' : 'none';
      if (show) walletAddr.textContent = 'üì± Open this page inside the Phantom app to connect.';
      else if (!getProvider()) walletAddr.textContent = '';
    }
    if (openPhantomBtn) {
      openPhantomBtn.addEventListener('click', () => { location.href = phantomBrowseLink(); });
    }
    document.addEventListener('visibilitychange', updateMobilePhantomCta);
    window.addEventListener('pageshow', updateMobilePhantomCta);

    // RPC resolver (query ‚Üí localStorage ‚Üí window var ‚Üí cluster)
    function resolveRpc() {
      try { const qp = new URLSearchParams(location.search).get('rpc'); if (qp) return qp; } catch {}
      try { const stored = localStorage.getItem('NNC_RPC'); if (stored) return stored; } catch {}
      const candidate = window.__NNC_RPC__;
      const looksPlaceholder = typeof candidate === 'string' && /REPLACE_|YOUR_(KEY|API_KEY)|YOUR-SUBDOMAIN/i.test(candidate);
      if (candidate && !looksPlaceholder) return candidate;
      return solanaWeb3.clusterApiUrl(CLUSTER);
    }

    // Price cache
    let lastPriceUSD = null, lastPriceAt = 0;
    async function getSolUsd() {
      const now = Date.now();
      if (lastPriceUSD && (now - lastPriceAt) < 60_000) return lastPriceUSD;
      try {
        const r = await fetch('https://api.coinbase.com/v2/prices/SOL-USD/spot', {cache:'no-store'});
        const j = await r.json(); const v = parseFloat(j?.data?.amount);
        if (Number.isFinite(v)) { lastPriceUSD = v; lastPriceAt = now; return v; }
      } catch {}
      try {
        const r = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=solana&vs_currencies=usd', {cache:'no-store'});
        const j = await r.json(); const v = parseFloat(j?.solana?.usd);
        if (Number.isFinite(v)) { lastPriceUSD = v; lastPriceAt = now; return v; }
      } catch {}
      return null;
    }

    // Exact SOL‚Üílamports
    function solToLamportsBigInt(solStr) {
      const s = String(solStr ?? '').trim();
      if (!/^\d+(\.\d+)?$/.test(s)) return null;
      const [i, f=''] = s.split('.');
      if (f.length > 9) return null;
      const intPart = BigInt(i) * 1_000_000_000n;
      const fracPart = BigInt((f + '000000000').slice(0,9));
      return intPart + fracPart;
    }

    function u64LEBytes(v) {
      const b = (typeof v === 'bigint') ? v : BigInt(v);
      const buf = new ArrayBuffer(8), view = new DataView(buf);
      if (view.setBigUint64) { view.setBigUint64(0, b, true); return new Uint8Array(buf); }
      let x=b; const out=new Uint8Array(8); for(let i=0;i<8;i++){ out[i]=Number(x&0xffn); x>>=8n; } return out;
    }

    function createSystemTransferIx(from, to, lamportsBig) {
      const keys = [
        { pubkey: from, isSigner: true, isWritable: true },
        { pubkey: to,   isSigner: false, isWritable: true },
      ];
      const data = new Uint8Array(12);
      new DataView(data.buffer).setUint32(0, 2, true);
      data.set(u64LEBytes(lamportsBig), 4);
      return new solanaWeb3.TransactionInstruction({ programId: solanaWeb3.SystemProgram.programId, keys, data });
    }

    function createMemoIx(text) {
      const memo = String(text || '').trim();
      if (!memo) return null;
      const bytes = Buffer.from(memo, 'utf8');
      if (bytes.length > 120) throw new Error('Memo too long (max ~120 bytes).');
      return new solanaWeb3.TransactionInstruction({
        programId: new solanaWeb3.PublicKey('MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr'),
        keys: [],
        data: bytes,
      });
    }

    async function connectWallet() {
      const provider = getProvider();
      if (!provider) {
        if (isMobileWeb()) {
          walletAddr.textContent = 'üì± Open this page inside the Phantom app to connect.';
          updateMobilePhantomCta();
        } else {
          alert("Phantom Wallet not found! Install it from https://phantom.app");
        }
        return;
      }
      try {
        const resp = await provider.connect();
        walletAddr.textContent = `‚úÖ Connected: ${resp.publicKey.toString()}`;
        updateUiState();
      } catch (e) {
        console.error(e);
        walletAddr.textContent = "‚ùå Wallet connection rejected.";
      }
    }

    async function buildTransferTx(connection, provider, lamportsBig, memoText) {
      const to = new solanaWeb3.PublicKey(TREASURY);
      const ix1 = createSystemTransferIx(provider.publicKey, to, lamportsBig);
      const tx = new solanaWeb3.Transaction().add(ix1);
      const ix2 = createMemoIx(memoText);
      if (ix2) tx.add(ix2);
      tx.feePayer = provider.publicKey;
      const { blockhash } = await connection.getLatestBlockhash("finalized");
      tx.recentBlockhash = blockhash;
      return tx;
    }

    function looksLikeBlockhashError(err) {
      const s = (err?.message || String(err || '')).toLowerCase();
      return s.includes('blockhash not found') || s.includes('blockhash expired') || s.includes('transaction expired');
    }
    function looksLikeForbidden(err) {
      const s = (err?.message || String(err || '')).toLowerCase();
      return s.includes('403') || s.includes('forbidden') || s.includes('"code": 403');
    }

    async function sendPayWithRetry(connection, provider, lamportsBig, memoText) {
      payBtn.disabled = true;
      try {
        let tx = await buildTransferTx(connection, provider, lamportsBig, memoText);
        let sig;
        if (typeof provider.signAndSendTransaction === "function") {
          const res = await provider.signAndSendTransaction(tx);
          sig = res.signature ?? res;
        } else {
          const signed = await provider.signTransaction(tx);
          sig = await connection.sendRawTransaction(signed.serialize());
        }
        return sig;
      } catch (err) {
        if (looksLikeForbidden(err)) throw new Error('RPC 403. Click "Set RPC" and paste your provider URL.');
        if (!looksLikeBlockhashError(err)) throw err;
        let tx = await buildTransferTx(connection, provider, lamportsBig, memoText);
        if (typeof provider.signAndSendTransaction === "function") {
          const res = await provider.signAndSendTransaction(tx);
          return res.signature ?? res;
        } else {
          const signed = await provider.signTransaction(tx);
          return await connection.sendRawTransaction(signed.serialize());
        }
      }
    }

    async function sendPayment() {
      const provider = getProvider();
      if (!provider) {
        if (isMobileWeb()) {
          walletAddr.textContent = 'üì± Open this page inside the Phantom app to connect.';
          updateMobilePhantomCta();
        } else {
          alert("Please install / connect Phantom first!");
        }
        return;
      }
      if (!provider.publicKey) { alert("Please connect Phantom first!"); return; }

      const amtStr = String(amountInput.value || '').trim();
      const amt = parseFloat(amtStr);
      const lamportsBig = solToLamportsBigInt(amtStr);
      if (!Number.isFinite(amt) || amt < MIN_SOL || amt > MAX_SOL || !lamportsBig) {
        amountHelp.classList.add('error');
        amountHelp.textContent = `Amount must be between ${MIN_SOL} and ${MAX_SOL} SOL.`;
        return;
      }

      try {
        txStatus.textContent = "Building transaction...";
        payBtn.disabled = true;

        const rpc = resolveRpc();
        const connection = new solanaWeb3.Connection(rpc, { commitment: "confirmed" });

        const sig = await sendPayWithRetry(connection, provider, lamportsBig, memoInput.value);
        txStatus.innerHTML = `‚è≥ Sent. Waiting for confirmation...<br>Sig: ${sig}`;

        const { blockhash, lastValidBlockHeight } = await connection.getLatestBlockhash("finalized");
        await connection.confirmTransaction({ signature: sig, blockhash, lastValidBlockHeight }, "confirmed");

        txStatus.innerHTML = `‚úÖ ${amtStr} SOL sent!<br>
          üîó <a href="https://explorer.solana.com/tx/${sig}?cluster=${CLUSTER}" target="_blank" style="color:#38bdf8;">View on Solana Explorer</a>`;
      } catch (err) {
        console.error(err);
        txStatus.textContent = "‚ùå " + (err.message || String(err));
        payBtn.disabled = false;
      }
    }

    // UI helpers
    async function refreshUsdEstimate() {
      const amtStr = String(amountInput.value || '').trim();
      const amt = parseFloat(amtStr);
      const price = await getSolUsd();
      const parts = [`Min ${MIN_SOL}`, `Max ${MAX_SOL}`];
      if (Number.isFinite(amt) && price) {
        const usd = amt * price;
        parts.push(`‚âà $${usd.toFixed(2)} @ $${price.toFixed(2)}/SOL`);
      } else parts.push('‚âà $‚Äî');
      amountHelp.classList.toggle('error', !(Number.isFinite(amt) && amt >= MIN_SOL && amt <= MAX_SOL));
      amountHelp.textContent = parts.join(' ‚Ä¢ ');
    }
    function updatePayButtonText() {
      const v = String(amountInput.value || '').trim();
      payBtn.textContent = `Pay ${v || '‚Äî'} SOL to NNC`;
    }
    function updateUiState() {
      const connected = !!getProvider()?.publicKey;
      const amt = parseFloat(String(amountInput.value || '').trim());
      const validAmt = Number.isFinite(amt) && amt >= MIN_SOL && amt <= MAX_SOL;
      payBtn.disabled = !(connected && validAmt);
      updateMobilePhantomCta();
    }

    // Set RPC prompt
    async function promptAndSaveRpc() {
      try {
        const current = (localStorage.getItem('NNC_RPC') || window.__NNC_RPC__ || '').trim();
        const input = prompt('Enter your Solana RPC URL (Helius/Alchemy/QuickNode):', current);
        if (!input) return;
        let url;
        try { url = new URL(input.trim()); if (!/^https?:$/i.test(url.protocol)) throw new Error(); } catch { alert('Invalid URL. Please paste a full https URL.'); return; }
        localStorage.setItem('NNC_RPC', url.toString()); window.__NNC_RPC__ = url.toString();
        txStatus.textContent = 'Testing RPC...';
        const testConn = new solanaWeb3.Connection(url.toString(), { commitment: 'processed' });
        await testConn.getLatestBlockhash('processed');
        txStatus.textContent = '‚úÖ RPC set and reachable.';
        if (getProvider()?.publicKey) updateUiState();
        if (setRpcBtn) setRpcBtn.style.display = 'none';
      } catch (e) {
        console.error(e);
        txStatus.textContent = '‚ùå RPC test failed. Check CORS / key / URL.';
      }
    }

    // Init
    window.addEventListener('load', async () => {
      try {
        const candidate = resolveRpc();
        if (candidate) {
          try { localStorage.setItem('NNC_RPC', candidate); } catch {}
          const testConn = new solanaWeb3.Connection(candidate, { commitment: 'processed' });
          await testConn.getLatestBlockhash('processed');
          if (setRpcBtn) setRpcBtn.style.display = 'none';
          txStatus.textContent = '‚úÖ RPC configured.';
        }
      } catch (_) {}
      await refreshUsdEstimate();
      updatePayButtonText();
      updateUiState();
    });

    // Events
    connectBtn.addEventListener("click", connectWallet);
    setRpcBtn.addEventListener("click", promptAndSaveRpc);
    amountInput.addEventListener("input", async () => {
      updatePayButtonText(); updateUiState(); await refreshUsdEstimate();
    });
    memoInput.addEventListener("input", updateUiState);
  </script>

  <!-- MOBILE FIX: deep-link to Phantom on mobile when provider isn't injected -->
  <script>
  (function(){
    function getProv(){return (window.solana&&window.solana.isPhantom&&window.solana)||(window.phantom&&window.phantom.solana)||null;}
    function isMobileNoProv(){var ua=navigator.userAgent||'';var m=/Android|iPhone|iPad|iPod/i.test(ua);return m && !getProv();}
    function deepLink(){return 'https://phantom.app/ul/browse/'+encodeURIComponent(location.href);}
    function updateCTA(){
      var btn=document.getElementById('openPhantomBtn'); var addr=document.getElementById('walletAddr');
      if(!btn||!addr) return;
      if(isMobileNoProv()){btn.style.display='inline-block'; if(!addr.textContent) addr.textContent='üì± Open this page inside the Phantom app to connect.';}
      else {btn.style.display='none';}
    }
    function bind(){
      var connect=document.getElementById('connectBtn');
      var pay=document.getElementById('payBtn');
      var openBtn=document.getElementById('openPhantomBtn');
      var addr=document.getElementById('walletAddr');

      if(openBtn){ openBtn.addEventListener('click', function(){ location.href=deepLink(); }); }

      if(connect){
        connect.addEventListener('click', function(e){
          if(isMobileNoProv()){
            e.preventDefault(); e.stopImmediatePropagation();
            if(addr) addr.textContent='üì± Opening Phantom‚Ä¶';
            location.href=deepLink();
          }
        }, {capture:true});
      }
      if(pay){
        pay.addEventListener('click', function(e){
          if(isMobileNoProv()){
            e.preventDefault(); e.stopImmediatePropagation();
            if(addr) addr.textContent='üì± Opening Phantom‚Ä¶';
            location.href=deepLink();
          }
        }, {capture:true});
      }
      updateCTA();
      document.addEventListener('visibilitychange', updateCTA);
      window.addEventListener('pageshow', updateCTA);
    }
    if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded', bind);} else {bind();}
  })();
  </script>
</body>
</html>
